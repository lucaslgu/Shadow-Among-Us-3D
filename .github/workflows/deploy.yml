name: Deploy Shadow Among Us 3D

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build client
        run: pnpm --filter client build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install rsync on EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo dnf install -y rsync"

      - name: Deploy to EC2
        run: |
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='aws' \
            --exclude='.claude' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='.env.production' \
            --exclude='nul' \
            -e "ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/app/

      - name: Upload SSL certificates
        run: |
          echo "$SSL_CERT" > /tmp/origin.pem
          echo "$SSL_KEY" > /tmp/origin.key
          SSH_CMD="ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no"
          SCP_CMD="scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no"
          $SCP_CMD /tmp/origin.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/origin.pem
          $SCP_CMD /tmp/origin.key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/origin.key
          $SSH_CMD ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo mkdir -p /etc/nginx/ssl && sudo mv /tmp/origin.pem /etc/nginx/ssl/origin.pem && sudo mv /tmp/origin.key /etc/nginx/ssl/origin.key && sudo chmod 600 /etc/nginx/ssl/origin.key"
          rm -f /tmp/origin.pem /tmp/origin.key
        env:
          SSL_CERT: ${{ secrets.EC2_SSL_CERT }}
          SSL_KEY: ${{ secrets.EC2_SSL_KEY }}

      - name: Configure nginx with SSL
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            # Write a clean nginx.conf (remove default server block)
            sudo tee /etc/nginx/nginx.conf > /dev/null << 'MAINCONF'
          user nginx;
          worker_processes auto;
          error_log /var/log/nginx/error.log notice;
          pid /run/nginx.pid;

          include /usr/share/nginx/modules/*.conf;

          events {
              worker_connections 1024;
          }

          http {
              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';
              access_log /var/log/nginx/access.log main;
              sendfile on;
              tcp_nopush on;
              keepalive_timeout 65;
              types_hash_max_size 4096;
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              include /etc/nginx/conf.d/*.conf;
          }
          MAINCONF

            # Write site config with SSL
            sudo tee /etc/nginx/conf.d/shadow-among-us.conf > /dev/null << 'SITECONF'
          server {
              listen 80;
              server_name _;
              return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl;
              server_name _;

              ssl_certificate /etc/nginx/ssl/origin.pem;
              ssl_certificate_key /etc/nginx/ssl/origin.key;

              location / {
                  proxy_pass http://127.0.0.1:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 86400;
              }
          }
          SITECONF

            # Remove any other default configs
            sudo rm -f /etc/nginx/conf.d/default.conf

            # Test and restart nginx
            sudo nginx -t
            sudo systemctl restart nginx
            sudo systemctl enable nginx

            echo "Nginx configured with SSL and restarted successfully"
          ENDSSH

      - name: Restart application
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            cd /home/ec2-user/app

            # Copy .env
            if [ -f /home/ec2-user/app/.env ]; then
              cp /home/ec2-user/app/.env packages/server/.env 2>/dev/null || true
            fi

            # Install dependencies
            pnpm install --frozen-lockfile

            # Stop old process
            pm2 delete shadow-among-us 2>/dev/null || true

            # Start server with tsx
            cd packages/server
            pm2 start "npx tsx src/index.ts" \
              --name shadow-among-us \
              --cwd /home/ec2-user/app/packages/server

            pm2 save

            echo "Deploy concluido! App rodando na porta 3001"
          ENDSSH

      - name: Health check
        run: |
          echo "Aguardando servidor iniciar..."
          sleep 15
          curl -f --max-time 15 http://${{ secrets.EC2_HOST }}:3001/health || echo "Health check falhou (servidor pode estar iniciando)"
