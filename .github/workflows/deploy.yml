name: Deploy Shadow Among Us 3D

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # 4. Cache pnpm
      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 5. Install
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 6. Build client (gera packages/client/dist/)
      - name: Build client
        run: pnpm --filter client build

      # 7. Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # 8. Ensure rsync on EC2
      - name: Install rsync on EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo dnf install -y rsync"

      # 9. Deploy via rsync
      - name: Deploy to EC2
        run: |
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='aws' \
            --exclude='.claude' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='.env.production' \
            --exclude='nul' \
            -e "ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/app/

      # 9. Install deps + restart PM2 no EC2
      - name: Restart application
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            cd /home/ec2-user/app

            # Copiar .env (criado pelo user-data do Terraform)
            if [ -f /home/ec2-user/app/.env ]; then
              cp /home/ec2-user/app/.env packages/server/.env 2>/dev/null || true
            fi

            # Instalar dependencias
            pnpm install --frozen-lockfile

            # Parar processo antigo
            pm2 delete shadow-among-us 2>/dev/null || true

            # Iniciar servidor com tsx (tsconfig tem noEmit)
            cd packages/server
            pm2 start "npx tsx src/index.ts" \
              --name shadow-among-us \
              --cwd /home/ec2-user/app/packages/server

            pm2 save

            echo "Deploy concluido! App rodando na porta 3001"
          ENDSSH

      # 11. Diagnostics
      - name: Diagnose EC2 services
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "=== NGINX STATUS ==="
            sudo systemctl status nginx --no-pager 2>&1 || true
            echo ""
            echo "=== NGINX CONFIG ==="
            sudo cat /etc/nginx/conf.d/shadow-among-us.conf 2>/dev/null || echo "NO CONFIG FILE"
            echo ""
            echo "=== LISTENING PORTS ==="
            sudo ss -tlnp | grep -E ':80|:3001|:443' || echo "No matches"
            echo ""
            echo "=== PM2 LIST ==="
            pm2 list
            echo ""
            echo "=== PM2 LOGS (last 30 lines) ==="
            pm2 logs shadow-among-us --lines 30 --nostream 2>/dev/null || true
            echo ""
            echo "=== CURL LOCALHOST:3001 ==="
            curl -s --max-time 5 http://127.0.0.1:3001/health || echo "FAILED"
            echo ""
            echo "=== CURL LOCALHOST:80 ==="
            curl -s --max-time 5 http://127.0.0.1:80/health || echo "FAILED"
          ENDSSH

      # 12. Health check
      - name: Health check
        run: |
          echo "Aguardando servidor iniciar..."
          sleep 10
          curl -f --max-time 15 http://${{ secrets.EC2_HOST }}/health || echo "Health check falhou (servidor pode estar iniciando)"
